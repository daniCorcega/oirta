<!DOCTYPE html>
<html class="fixed">
  <head>

    <!-- Basic -->
    <meta charset="UTF-8">

    <meta name="keywords" content="HTML5 Admin Template" />
    <meta name="description" content="Atrio Seguros">
    <meta name="author" content="cleteci">

    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Web Fonts  -->
    <link href="assets/fonts/fonts.css" rel="stylesheet" type="text/css" />

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="assets/vendor/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="assets/vendor/magnific-popup/magnific-popup.css" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="assets/stylesheets/theme.css" />

    <!-- Skin CSS -->
    <link rel="stylesheet" href="assets/stylesheets/skins/default.css" />

    <!-- Theme Custom CSS -->
    <link rel="stylesheet" href="assets/stylesheets/theme-custom.css">
    <link rel="stylesheet" href="assets/stylesheets/custom.css">

    <!-- Head Libs -->
    <script src="assets/vendor/modernizr/modernizr.js"></script>

  </head>
  <body>
    <section class="body-sign">
      <div class="center-sign">
	<a href="/" class="logo pull-left"> <img src="assets/images/logo.png" height="54" alt="Porto Admin" />
	</a>

	<div class="panel panel-sign">
	  <div class="panel-title-sign mt-xl text-right">
	    <h2 class="title text-uppercase text-bold m-none">
	      <i class="fa fa-user mr-xs"></i> Nueva Clave
	    </h2>
	  </div>
	  <div class="panel-body">
            <div class="alert alert-info">
              <p>Por favor ingrese los datos solicitados para realizar el cambio de clave.</p><br/>
              <p class="m-none text-semibold h6">ACLARATORIA: El bot&oacute;n se activar&aacute; solo cuando se cumplan todas las condiciones</p>
            </div>
	    <form action="j_security_check" method="post" id="login-form">
              <div class="form-group mb-lg">
                <label>C&oacute;digo de Seguridad</label>
                <div class="input-group input-group-icon">
                  <input id="token" type="text" class="form-control clave">
                  <span class="input-group-addon">
                    <span class="icon">
                      <i id="mostrarTokenOk" class="fa fa-check tiene-exito"></i>
                      <i id="mostrarTokenError" class="fa fa-times tiene-error"></i>
                    </span>
                  </span>
                </div>
              </div>
              <div class="form-group mb-none">
                <div class="row">
                  <div class="col-sm-6 mb-lg">
                    <label>Clave</label>
                    <div class="input-group input-group-icon">
                      <input type="password" class="form-control clave" id="claveNueva">
                      <span class="input-group-addon">
                        <span class="icon">
                          <i id="mostrarClaveNuevaOk" class="fa fa-check tiene-exito"></i>
                          <i id="mostrarClaveNuevaError" class="fa fa-times tiene-error"></i>
                        </span>
                      </span>
                    </div>
                  </div>
                  <div class="col-sm-6 mb-lg">
                    <label>Confirmaci&oacute;n de Clave</label>
                    <div class="input-group input-group-icon">
                      <input type="password" class="form-control clave" id="claveConfirma">
                      <span class="input-group-addon">
                        <span class="icon">
                          <i id="mostrarClaveConfirmaOk" class="fa fa-check tiene-exito"></i>
                          <i id="mostrarClaveConfirmaError" class="fa fa-times tiene-error"></i>
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-sm-offset-6 col-sm-6 text-right">
                  <div class="btn btn-primary hidden-xs cambiar">Cambiar Clave</div>
                  <div class="btn btn-primary btn-block btn-lg visible-xs mt-lg cambiar">Cambiar Clave</div>
                </div>
              </div>
            </form>
	  </div>
	</div>
	<p class="text-center text-muted mt-md mb-md">&#169; Copyright 2014. Todos los derechos reservados.</p>
      </div>
    </section>

    <div class="modal fade modal-block-danger" id="modalError" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <section class="panel">
          <header class="panel-heading">
            <h2 class="panel-title">Error</h2>
          </header>
          <div class="panel-body">
            <div class="modal-wrapper">
              <div class="modal-icon">
                <i class="fa fa-times-circle"></i>
              </div>
              <div class="modal-text">
                <h4>Error</h4>
                <p id="error-mensaje">El c&oacute;digo introducido no es v&aacute;lido o usted introdujo mal la clave o la confimaci&oacute;n de la misma. Por favor, verifique los datos.</p>
              </div>
            </div>
          </div>
          <footer class="panel-footer">
            <div class="row">
              <div class="col-md-12 text-right">
                <button class="btn btn-danger" onclick="$('#modalError').modal('hide')">OK</button>
              </div>
            </div>
          </footer>
        </section>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade modal-block-success" id="modalOk" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <section class="panel">
          <header class="panel-heading">
            <h2 class="panel-title">&Eacute;xito</h2>
          </header>
          <div class="panel-body">
            <div class="modal-wrapper">
              <div class="modal-icon">
                <i class="fa fa-check"></i>
              </div>
              <div class="modal-text">
                <h4>&Eacute;xito</h4>
                <p>Usted ha cambiado la clave. Ahora puede iniciar sesi&oacute;n con su nueva clave.</p>
              </div>
            </div>
          </div>
          <footer class="panel-footer">
            <div class="row">
              <div class="col-md-12 text-right">
                <button class="btn btn-success" onclick="login();">OK</button>
              </div>
            </div>
          </footer>
        </section>
      </div>
    </div>
    <script src="assets/vendor/jquery/jquery.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script>
      function login() {
        window.location = "login.xhtml";
      };
      function actualizarToken() {
        var tokenString = $("#token").val();
        var valido = false;
        $("#mostrarTokenOk").hide();
        $("#mostrarTokenError").hide();
        if (tokenString.length != 8 && tokenString.length != 0) {
          $("#mostrarTokenOk").hide();
          $("#mostrarTokenError").show();
        } else if (tokenString.length == 8) {
          $("#mostrarTokenOk").show();
          $("#mostrarTokenError").hide();
          valido = true;
        }
        return valido;
      }

      function actualizarClaveNueva() {
        var claveNuevaString = $("#claveNueva").val();
        var valido = false;
        $("#mostrarClaveNuevaOk").hide();
        $("#mostrarClaveNuevaError").hide();
        if (claveNuevaString.length > 0 && claveNuevaString.length < 6) {
          $("#mostrarClaveNuevaOk").hide();
          $("#mostrarClaveNuevaError").show();
        } else if (claveNuevaString.length >= 6){
          $("#mostrarClaveNuevaOk").show();
          $("#mostrarClaveNuevaError").hide();
          valido = true;
        }
        return valido;
      }

      function actualizarClaveConfirma() {
        var claveConfirmaString = $("#claveConfirma").val();
        var claveNuevaString = $("#claveNueva").val();
        var valido = false;
        $("#mostrarClaveConfirmaOk").hide();
        $("#mostrarClaveConfirmaError").hide();
        if ((claveConfirmaString.length > 0 && claveConfirmaString.length < 6) || (claveConfirmaString.length >= 6 && claveNuevaString != claveConfirmaString)) {
          $("#mostrarClaveConfirmaOk").hide();
          $("#mostrarClaveConfirmaError").show();
        } else if (claveConfirmaString.length >= 6 && claveNuevaString == claveConfirmaString) {
          $("#mostrarClaveConfirmaOk").show();
          $("#mostrarClaveConfirmaError").hide();
          valido = true
          }
          return valido;
      }

      function evaluar() {
        var claveNueva = actualizarClaveNueva();
        var claveConfirma =actualizarClaveConfirma();
        var token = actualizarToken();
        if (claveNueva && claveConfirma && token) {
          $(".cambiar").attr("disabled",false);
        } else {
          $(".cambiar").attr("disabled",true);
        }
      }

      function cambiarClave() {
        var stringToken = $("#token").val();
        var stringClaveNueva = $("#claveNueva").val();
        var stringClaveConfirma = $("#claveConfirma").val();

        $.ajax({
          "type":"POST",
          "async": false,
          "url":"/atrio-web/api/v1/users/reset-password",
          "contentType": "application/json",
          "data":JSON.stringify({
            token : stringToken ,
            newPassword : stringClaveNueva,
            confirmPassword : stringClaveConfirma
          }),
          "success": function (data) {
            $("#modalOk").modal({backdrop:"static"});
          },
          "error": function (response) {
            if (response.status == 200) {
              $("#modalOk").modal({backdrop:"static"});
            } else {
              $("#modalError").modal();
            }
          }
        });
      }

      $(".clave").on('keyup keypress',function (){
        evaluar();
      });

      $(".clave").on('keyup',function (){
        if(event.keyCode == 13){
          cambiarClave();
        };
      });

      $(".cambiar").click(function () {
        cambiarClave();
      });

      evaluar();
    </script>
  </body>
</html>
